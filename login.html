<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç™»å…¥ | å¿ƒæƒ…æ‰­è›‹æ©Ÿ</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Noto Sans TC", sans-serif;
      background-color: #f5f0ff;
      background-image: url('assets/gacha-bg.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      min-height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 16px;
    }
    .card {
      width: 100%;
      max-width: 360px;
      background: rgba(255,255,255,.75);
      padding: 28px;
      border-radius: 18px;
      box-shadow: 0 20px 45px rgba(108,92,231,.2);
      border: 1px solid rgba(255,255,255,.4);
      backdrop-filter: blur(8px);
    }
    h2 { margin: 0 0 16px; text-align: center; }
    input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 1px solid #cfcfcf; font-size: 15px; }
    button { width: 100%; padding: 12px; margin-top: 12px; border: none; border-radius: 12px; background: #6c5ce7; color: white; font-weight: bold; cursor: pointer; }
    button:hover { opacity: .9; }
    .msg { color: #c00; font-size: 13px; min-height: 18px; text-align: center; margin-top: 10px; padding: 10px; border-radius: 12px; border: 1px solid #e0e0e0; background: #fdfdfd; }
    .msg:empty { padding: 0; border: none; background: transparent; min-height: 0; }
    .diagnose { margin-top: 16px; font-size: 13px; color: #333; background: #fafafa; border-radius: 10px; padding: 10px; border: 1px solid #ddd; }
    .ok { color: #0a0; }
    .fail { color: #c00; }
  </style>
</head>
<body>
  <div class="card">
    <h2>ç™»å…¥å¸³è™Ÿ</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="å¯†ç¢¼" />
    <div class="msg" id="msg"></div>
    <button id="loginBtn">ç™»å…¥</button>
    <button id="signupBtn" style="background:#4dabf7">è¨»å†Šæ–°å¸³è™Ÿ</button>

    <!-- ğŸ” è‡ªå‹•è¨ºæ–·çµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
    <div class="diagnose" id="diagnose">æª¢æŸ¥ Firebase é€£ç·šä¸­...</div>
  </div>

  <script type="module">
    // === åŒ¯å…¥ Firebase SDK ===
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { 
      getAuth, 
      setPersistence, 
      browserLocalPersistence, 
      signInWithEmailAndPassword, 
      createUserWithEmailAndPassword,
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    // === Firebase è¨­å®šï¼ˆèˆ‡ app.js ç›¸åŒï¼‰===
    const firebaseConfig = {
      apiKey: "AIzaSyCcbtsjKSFRBg66x-nVyOB0wljwilxTVqY",
      authDomain: "mood-gacha.firebaseapp.com",
      projectId: "mood-gacha",
      storageBucket: "mood-gacha.appspot.com",
      messagingSenderId: "439343502117",
      appId: "1:439343502117:web:a09add8afb9de07ed5c0cc",
      measurementId: "G-7HCLV1Y6H8"
    };

    // åˆå§‹åŒ– Firebaseï¼ˆé¿å…é‡è¤‡ï¼‰
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const diagnoseBox = document.getElementById("diagnose");

    // ğŸ” è‡ªå‹•è¨ºæ–·é€£ç·šç‹€æ…‹
    async function testFirebaseConnection() {
      try {
        const testEmail = "diagnostic@test.example.com";
        const testPass = "abc12345";
        // é€™è£¡åªæ˜¯æ¸¬è©¦è«‹æ±‚ï¼Œé æœŸæœƒå¤±æ•—ä½†èƒ½å›å‚³éŒ¯èª¤ä»£è¡¨é€£ç·šæˆåŠŸ
        await createUserWithEmailAndPassword(auth, testEmail, testPass);
        diagnoseBox.innerHTML = "âœ… <span class='ok'>Firebase é€£ç·šæˆåŠŸï¼šè¨­å®šæ­£ç¢ºã€‚</span>";
      } catch (e) {
        // æ ¹æ“šéŒ¯èª¤é¡å‹é¡¯ç¤º
        if (e.code === "auth/email-already-in-use") {
          diagnoseBox.innerHTML = "âœ… <span class='ok'>Firebase é€£ç·šæˆåŠŸï¼šå°ˆæ¡ˆè¨­å®šæ­£ç¢ºã€‚</span>";
        } else if (e.code === "auth/invalid-api-key") {
          diagnoseBox.innerHTML = "âŒ <span class='fail'>ç„¡æ•ˆçš„ API Keyï¼Œè«‹é‡æ–°å¾ Firebase Console è¤‡è£½ CDN configã€‚</span>";
        } else if (e.code === "auth/network-request-failed") {
          diagnoseBox.innerHTML = "âš ï¸ <span class='fail'>ç„¡æ³•é€£ç·šåˆ° Firebaseï¼Œå¯èƒ½ç¶²åŸŸæœªæˆæ¬Šæˆ–ç¶²è·¯è¢«æ“‹ã€‚</span>";
        } else if (e.code === "auth/invalid-credential") {
          diagnoseBox.innerHTML = "âš ï¸ <span class='fail'>é€£ç·šæˆåŠŸä½†ç™»å…¥è¢«æ‹’ï¼Œè«‹æª¢æŸ¥ Authentication è¨­å®šã€‚</span>";
        } else {
          diagnoseBox.innerHTML = "âš ï¸ éŒ¯èª¤ä»£ç¢¼ï¼š" + e.code + "<br><span class='fail'>" + e.message + "</span>";
        }
        console.warn("[è¨ºæ–·çµæœ]", e.code, e.message);
      }
    }

    // åŸ·è¡Œæ¸¬è©¦
    testFirebaseConnection();

    // âœ… è‹¥å·²ç™»å…¥å‰‡è·³é¦–é 
    onAuthStateChanged(auth, (user) => {
    // å¦‚æœç™»å…¥ç‹€æ…‹ç¢ºå®šä½†å·²åœ¨ index.html å°±ä¸è¦å†è·³
        if (user && !window.location.href.includes("index.html")) {
            console.log("âœ… å·²ç™»å…¥ï¼Œå°å‘é¦–é ");
            window.location.replace("index.html");
        }
    });


    // âœ… ä¿æŒç™»å…¥ç‹€æ…‹
    setPersistence(auth, browserLocalPersistence)
      .then(() => {
        // ç™»å…¥äº‹ä»¶
        document.getElementById("loginBtn").onclick = async () => {
          const email = document.getElementById("email").value.trim();
          const pw = document.getElementById("password").value.trim();
          const msg = document.getElementById("msg");
          msg.textContent = "";
          try {
            await signInWithEmailAndPassword(auth, email, pw);
            msg.textContent = "ç™»å…¥æˆåŠŸï¼";
            window.location.href = "index.html";
          } catch (e) {
            msg.textContent = "ç™»å…¥å¤±æ•—ï¼š" + e.message;
          }
        };

        // è¨»å†Šäº‹ä»¶
        document.getElementById("signupBtn").onclick = async () => {
          const email = document.getElementById("email").value.trim();
          const pw = document.getElementById("password").value.trim();
          const msg = document.getElementById("msg");
          msg.textContent = "";
          try {
            await createUserWithEmailAndPassword(auth, email, pw);
            msg.textContent = "è¨»å†ŠæˆåŠŸï¼è«‹é‡æ–°ç™»å…¥ã€‚";
          } catch (e) {
            msg.textContent = "è¨»å†Šå¤±æ•—ï¼š" + e.message;
          }
        };
      })
      .catch((error) => {
        console.error("âŒ è¨­å®šç™»å…¥æŒä¹…åŒ–å¤±æ•—", error);
      });
  </script>
</body>
</html>
